
whoami=$(whoami)
port=$(bash $GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/bin/get_port_local)
if [[ "$whoami" == "root" ]] || [[ "$port" != "80" ]]; then
    rm -rf /tmp/go-build* > /dev/null 2>&1
else
    sudo rm -rf /tmp/go-build* > /dev/null 2>&1
fi
bash $GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/bin/kill_go_watch

if [ ! -f "$GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/webConfig.json" ]; then
    say "Copying web config and npm install for first time development process"
    mkdir -p $GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/log/plugins
    cd $GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/bin
    chmod +x *
fi

if [ ! -d "$GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/web/app/node_modules" ]; then
    say "npm install starting"
    cd $GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/web/app
    #https://github.com/sass/node-sass/issues/1847
    #node-sass needs unsafe-perm
    npm install --unsafe-perm
    say "npm install ended"
fi

if [ ! -f "$GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/web/app/dist/javascript/go-core-app.js.gz" ]; then
    say "copy dist tar balls starting"
    cd $GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/web/app/javascript
    bash build.sh
    say "copy dist tar balls ending"
fi


echo "" > $GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/log/app.log
echo "" > $GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/log/db.log
echo "" > /tmp/go_watch.log
echo "" > $GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/log/npm.log

if [[ "$whoami" == "root" ]]; then
    rm $GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/log/mongo.log
else
    sudo rm $GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/log/mongo.log
fi
bash $GOPATH/src/github.com/davidrenne/goCoreCreateAppGeneration/bin/dev
